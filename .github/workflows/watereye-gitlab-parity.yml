name: WaterEye CI (GitLab parity)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: "Manual action to run (mirrors GitLab manual jobs)"
        type: choice
        required: true
        options:
          - deploy_test
          - destroy_dev
          - destroy_test
      domain_name:
        description: "Domain name for the WaterEye application"
        required: false
        default: "zaproject.com"

concurrency:
  group: watereye-${{ github.ref }}
  cancel-in-progress: true

env:
  # Equivalent to GitLab's DOMAIN_NAME variable (defaults to zaproject.com)
  DOMAIN_NAME: ${{ github.event.inputs.domain_name || 'zaproject.com' }}

jobs:
  build_the_application:
    name: Build the application
    runs-on: ubuntu-latest
    container:
      image: amazonlinux:2023
    services:
      docker:
        image: docker:24.0.6-dind
        options: --privileged
        ports:
          - 2375:2375
    env:
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
    steps:
      - name: Install prerequisites (git, tar, gzip, docker CLI)
        run: |
          set -euo pipefail
          dnf -y update
          dnf -y install git tar gzip ca-certificates curl docker

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build (from script)
        run: |
          set -euo pipefail
          bash scripts/ci/build.sh

      - name: Upload artifact (./watereye)
        uses: actions/upload-artifact@v4
        with:
          name: watereye
          path: ./watereye
          if-no-files-found: error

  deploy_to_dev:
    name: Deploy to dev
    needs: [build_the_application]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}
    container:
      image: amazonlinux:2023
    environment:
      name: dev
      url: http://${{ github.event.repository.name }}-dev.${{ env.DOMAIN_NAME }}
    steps:
      - name: Install prerequisites (git, tar, gzip)
        run: |
          set -euo pipefail
          dnf -y update
          dnf -y install git tar gzip ca-certificates

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: watereye
          path: ./watereye

      - name: Before script (deploy/destroy)
        run: |
          set -euo pipefail
          bash scripts/ci/deploy_destroy_before.sh

      - name: Deploy
        run: |
          set -euo pipefail
          bash scripts/ci/deploy.sh dev

  deploy_to_test:
    name: Deploy to test (manual)
    needs: [build_the_application]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy_test' }}
    container:
      image: amazonlinux:2023
    environment:
      name: test
      url: http://${{ github.event.repository.name }}-test.${{ env.DOMAIN_NAME }}
    steps:
      - name: Install prerequisites (git, tar, gzip)
        run: |
          set -euo pipefail
          dnf -y update
          dnf -y install git tar gzip ca-certificates

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: watereye
          path: ./watereye

      - name: Before script (deploy/destroy)
        run: |
          set -euo pipefail
          bash scripts/ci/deploy_destroy_before.sh

      - name: Deploy
        run: |
          set -euo pipefail
          bash scripts/ci/deploy.sh test

  destroy_dev:
    name: Destroy dev (manual)
    needs: [build_the_application]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy_dev' }}
    container:
      image: amazonlinux:2023
    environment:
      name: dev
      url: http://${{ github.event.repository.name }}-dev.${{ env.DOMAIN_NAME }}
    steps:
      - name: Install prerequisites (git, tar, gzip)
        run: |
          set -euo pipefail
          dnf -y update
          dnf -y install git tar gzip ca-certificates

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: watereye
          path: ./watereye

      - name: Before script (deploy/destroy)
        run: |
          set -euo pipefail
          bash scripts/ci/deploy_destroy_before.sh

      - name: Destroy
        run: |
          set -euo pipefail
          bash scripts/ci/destroy.sh dev

  destroy_test:
    name: Destroy test (manual)
    needs: [build_the_application]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy_test' }}
    container:
      image: amazonlinux:2023
    environment:
      name: test
      url: http://${{ github.event.repository.name }}-test.${{ env.DOMAIN_NAME }}
    steps:
      - name: Install prerequisites (git, tar, gzip)
        run: |
          set -euo pipefail
          dnf -y update
          dnf -y install git tar gzip ca-certificates

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: watereye
          path: ./watereye

      - name: Before script (deploy/destroy)
        run: |
          set -euo pipefail
          bash scripts/ci/deploy_destroy_before.sh

      - name: Destroy
        run: |
          set -euo pipefail
          bash scripts/ci/destroy.sh test

